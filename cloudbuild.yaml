# Cloud Build의 빌드 단계를 정의합니다.
steps:
  # 1단계: Docker 이미지 빌드
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '--tag'
      - '${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE_NAME}:${COMMIT_SHA}'
      - '.'
      - '--build-arg'
      - 'VITE_KAKAO_API_KEY=${_VITE_KAKAO_API_KEY}'
      - '--build-arg'
      - 'VITE_SUPABASE_URL=${_VITE_SUPABASE_URL}'
      - '--build-arg'
      - 'VITE_SUPABASE_ANON_KEY=${_VITE_SUPABASE_ANON_KEY}'
      - '--build-arg'
      - 'VITE_GEMINI_API_KEY=${_VITE_GEMINI_API_KEY}'
    # Secret Manager에서 환경 변수 값을 가져옵니다.
    secretEnv:
      - 'VITE_KAKAO_API_KEY'
      - 'VITE_SUPABASE_URL'
      - 'VITE_SUPABASE_ANON_KEY'
      - 'VITE_GEMINI_API_KEY'

  # 2단계: 빌드된 이미지를 Artifact Registry에 푸시
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', '${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE_NAME}:${COMMIT_SHA}']

  # 3단계: Cloud Run에 새 이미지로 배포
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}'
      - '--image'
      - '${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE_NAME}:${COMMIT_SHA}'
      - '--region'
      - '${_LOCATION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated' # 인증되지 않은 외부 요청을 허용합니다.

# 빌드된 이미지를 Artifact Registry에 저장합니다.
images:
  - '${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE_NAME}:${COMMIT_SHA}'

# 사용 가능한 시크릿을 정의합니다.
availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/VITE_KAKAO_API_KEY/versions/latest
      env: 'VITE_KAKAO_API_KEY'
    - versionName: projects/$PROJECT_ID/secrets/VITE_SUPABASE_URL/versions/latest
      env: 'VITE_SUPABASE_URL'
    - versionName: projects/$PROJECT_ID/secrets/VITE_SUPABASE_ANON_KEY/versions/latest
      env: 'VITE_SUPABASE_ANON_KEY'
    - versionName: projects/$PROJECT_ID/secrets/VITE_GEMINI_API_KEY/versions/latest
      env: 'VITE_GEMINI_API_KEY'

# 빌드 옵션을 설정합니다.
options:
  logging: CLOUD_LOGGING_ONLY

# 대체 변수를 정의합니다. Cloud Build 트리거에서 이 값들을 설정할 수 있습니다.
substitutions:
  _SERVICE_NAME: 'chungcheong-market-map'
  _REPOSITORY: 'chungcheong-market-map-repo' # 3단계에서 생성한 Artifact Registry 저장소 이름
  _LOCATION: 'asia-northeast3' # 서울 리전
